<html>
<head>
	<style>
	*{padding: 0; margin:0;}
	canvas{ background: #85CBC6; display: block; margin: 0 auto;}
	</style>
</head>
<body>
<canvas id= "myCanvas" width="800" height="600"></canvas>
<script type="text/javascript">
{ //setup stuff
var W = 800, H = 600;
var mouseX;
var mouseY;
var mouseIsDown = 0;
var wPressed = false;
var aPressed = false;
var sPressed = false;
var dPressed = false;
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
document.addEventListener("mousemove", mouseMoveHandler, false);
canvas.addEventListener("mousedown", getPosition, false);
canvas.addEventListener("mouseup", getPosition2, false);
document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);
function mouseMoveHandler(e) {
    mouseX = e.clientX - canvas.offsetLeft;
    mouseY = e.clientY - canvas.offsetTop;
}
function getPosition2(event){
	mouseIsDown = 0;
}
function getPosition(event)
{
	if(mouseIsDown != 2)
	{
		mouseIsDown = 1;
	}
}
function keyDownHandler(e)
{
	if(e.keyCode == 87)
	{
		wPressed = true;
	}
	if(e.keyCode == 65)
	{
		aPressed = true;
	}
	if(e.keyCode == 83)
	{
		sPressed = true;
	}
	if(e.keyCode == 68)
	{
		dPressed = true;
	}
}
function keyUpHandler(e)
{
	if(e.keyCode == 87)
	{
		wPressed = false;
	}
	if(e.keyCode == 65)
	{
		aPressed = false;
	}
	if(e.keyCode == 83)
	{
		sPressed = false;
	}
	if(e.keyCode == 68)
	{
		dPressed = false;
	}
}
}

{ //kritikal functions

function Btn(x,y,w,h,hover,pressed,color,hoverColor,text,textColor,textHoverColor,font)
{
	this.x = x;
	this.y = y;
	this.w = w;
	this.h = h;
	this.hover = hover;
	this.pressed = pressed;
	this.color = color;
	this.hoverColor = hoverColor;
	this.text = text;
	this.textColor = textColor;
	this.textHoverColor = textHoverColor;
	this.font = font;
}

var btns = [];

//btns.push(new Btn(0,0,120,80,false,false,"red","white","cool","white","red","60px Arial"));

function drawBtns()
{
	for(var a=0; a<btns.length; a++)
	{
		if(pointRect(pX,pY,btns[a].x,btns[a].y,btns[a].w,btns[a].h))
		{
			btns[a].hover = true;
			ctx.fillStyle = btns[a].hoverColor;
			ctx.fillRect(btns[a].x,btns[a].y,btns[a].w,btns[a].h);
			ctx.fillStyle = btns[a].textHoverColor;
			ctx.font = btns[a].font;
			ctx.fillText(btns[a].text,btns[a].x,btns[a].y+btns[a].h-20);
			if(mouseIsDown)
			{
				btns[a].pressed = true;
			}
		}
		else
		{
			ctx.fillStyle = btns[a].color;
			ctx.fillRect(btns[a].x,btns[a].y,btns[a].w,btns[a].h);
			ctx.fillStyle = btns[a].textColor;
			ctx.font = btns[a].font;
			ctx.fillText(btns[a].text,btns[a].x,btns[a].y+btns[a].h-20);
		}
	}
}

function pointRect(px,py,x,y,w,h)
{
	if(px >= x && px <= x + w &&
	py >= y && py <= y + h)
	{
		return true;
	}
	return false;
}

function pointCirc(px,py,x,y,r)
{
	if(Math.sqrt(Math.pow(Math.abs(px-x),2)+Math.pow(Math.abs(py-y),2))<=r)
	{
		return true;
	}
	return false;
}

function rectRect(x1,y1,w1,h1,x2,y2,w2,h2)
{
	if(x1+w1 >= x2 && x1 <= x2+w2 &&
	y1+h1 >= y2 && y1 <= y2+h2)
	{
		return true;
	}
	return false;
}

function distance(x1,y1,x2,y2)
{
	return(Math.sqrt(Math.pow(Math.abs(x1-x2),2)+Math.pow(Math.abs(y1-y2),2)))
}

function pointLine(x1,y1,x2,y2,x3,y3)
{
	let dist1 = distance(x1,y1,x3,y3);
	let dist2 = distance(x2,y2,x3,y3);
	let lineLength = distance(x1,y1,x2,y2);
	if(dist1 + dist2 <= lineLength + 0.1)
	{
		return true;
	}
	return false;
}

function circCirc(x1,y1,r1,x2,y2,r2)
{
	if(distance(x1,y1,x2,y2)<=r1+r2)
	{
		return true;
	}
	return false;
}

function lineLine(x1,y1,x2,y2, x3,y3,x4,y4)
{
	var uA = ((x4-x3)*(y1-y3) - (y4-y3)*(x1-x3)) / ((y4-y3)*(x2-x1) - (x4-x3)*(y2-y1));
	var uB = ((x2-x1)*(y1-y3) - (y2-y1)*(x1-x3)) / ((y4-y3)*(x2-x1) - (x4-x3)*(y2-y1));
	if (uA >= 0 && uA <= 1 && uB >= 0 && uB <= 1)
	{
		var intersectionX = x1 + (uA * (x2-x1));
		var intersectionY = y1 + (uA * (y2-y1));
		return [intersectionX,intersectionY];
	}
	return false;
}

}

let playerX = 10;
let playerY = 10;
let playerRot = 0;
let playerXV = 0;
let playerYV = 0;
let playerW = .2;
let playerSpeed = .06;

let FOV = 90;
let resolution = W;
var renderDistance = 9999;

let walls = [];
let scale2D = 4;
let wallSize = 1;
let map = [
[1,1,1,1,1,1,1,1,1],
[0,0,1,0,0,0,0,0,1],
[1,0,1,0,1,0,1,1,1],
[1,0,0,0,1,0,0,0,1],
[1,1,1,0,1,1,1,0,1],
[1,0,0,0,0,0,1,0,1],
[1,0,1,1,0,1,1,1,1],
[1,0,0,1,0,0,0,0,0],
[1,1,1,1,1,1,1,1,1]
];

function Wall(x1,y1,x2,y2,color)
{
	this.x1 = x1;
	this.y1 = y1;
	this.x2 = x2;
	this.y2 = y2;
	this.color = color;
}

function convertMap()
{
	for(var a = 0; a < map.length; a++)
	{
		for(var b = 0; b < map[a].length; b++)
		{
			if(map[a][b]==1)
			{
				walls.push(new Wall(wallSize*b,wallSize*a,wallSize*b+wallSize,wallSize*a,"#9C9C9C"));
				walls.push(new Wall(wallSize*b,wallSize*a,wallSize*b,wallSize*a+wallSize,"#909090"));
				walls.push(new Wall(wallSize*b+wallSize,wallSize*a,wallSize*b+wallSize,wallSize*a+wallSize,"#909090"));
				walls.push(new Wall(wallSize*b,wallSize*a+wallSize,wallSize*b+wallSize,wallSize*a+wallSize,"#9C9C9C"));
			}
		}
	}
}

convertMap();

function drawWalls()
{	
	ctx.fillStyle = "#7DD67A";
	ctx.fillRect(0,H/2,W,H,2);
	for(var a = 0; a<=resolution; a++)
	{
		var leftBound = FOV/2;
		var x2 = playerX + Math.cos(Math.PI * (playerRot - leftBound + FOV/resolution*a) / 180) * renderDistance;
		var y2 = playerY + Math.sin(Math.PI * (playerRot - leftBound + FOV/resolution*a) / 180) * renderDistance;
		var dist = 9999;
		var hit;
		var color;
		for(var b = 0; b < walls.length;b++)
		{
			if(lineLine(playerX,playerY,x2,y2,walls[b].x1,walls[b].y1,walls[b].x2,walls[b].y2) != false)
			{
				var thisHit = lineLine(playerX,playerY,x2,y2,walls[b].x1,walls[b].y1,walls[b].x2,walls[b].y2);
				if(distance(playerX,playerY,thisHit[0],thisHit[1]) < dist)
				{
					dist = distance(playerX,playerY,thisHit[0],thisHit[1]);
					hit = thisHit;
					color = walls[b].color;
				}		
			}
		}
		if(hit != null)
		{
			ctx.fillStyle = color;
			ctx.fillRect(a*(W/resolution),(600/2)-(600/dist)/2,(W/resolution),15/dist);
		}
	}	
}

function drawPlayer2D()
{
	ctx.fillStyle = "red";
	ctx.beginPath();
	ctx.arc(playerX*scale2D,playerY*scale2D,playerW*5*scale2D/2,0,2*Math.PI);
	ctx.closePath();
	ctx.fill();
	
	ctx.strokeStyle = "white";
	ctx.beginPath();
	ctx.moveTo(playerX*scale2D,playerY*scale2D);
	ctx.lineTo(playerX*scale2D + Math.cos(Math.PI * playerRot / 180) * 2*scale2D,playerY*scale2D + Math.sin(Math.PI * playerRot / 180) *2*scale2D);
	ctx.closePath();
	ctx.stroke();
}

function drawWalls2D()
{
	for(let a=0; a < map.length;a++)
	{
		for(let b=0; b < map[a].length;b++)
		{
			if(map[a][b] == 1)
			{
				ctx.strokeStyle = "white";
				ctx.fillStyle = "white";
				ctx.beginPath();
				ctx.rect(b*wallSize*scale2D,a*wallSize*scale2D,wallSize*scale2D,wallSize*scale2D);
				ctx.stroke();
				
				let side1 = [b*wallSize,a*wallSize-playerW,wallSize,playerW];
				let side2 = [b*wallSize-playerW,a*wallSize,playerW,wallSize];
				let side3 = [b*wallSize+wallSize,a*wallSize,playerW,wallSize];
				let side4 = [b*wallSize,a*wallSize+wallSize,wallSize,playerW];
				if(rectRect(playerX-(playerW/2),playerY-(playerW/2),playerW,playerW,side1[0],side1[1],side1[2],side1[3])==true)
				{
					playerY = side1[1]-(playerW/2);
				}
				if(rectRect(playerX-(playerW/2),playerY-(playerW/2),playerW,playerW,side2[0],side2[1],side2[2],side2[3])==true)
				{
					playerX = side2[0]-(playerW/2);
				}
				if(rectRect(playerX-(playerW/2),playerY-(playerW/2),playerW,playerW,side3[0],side3[1],side3[2],side3[3])==true)
				{
					playerX = side3[0]+playerW+(playerW/2);
				}
				if(rectRect(playerX-(playerW/2),playerY-(playerW/2),playerW,playerW,side4[0],side4[1],side4[2],side4[3])==true)
				{
					playerY = side4[1]+playerW+(playerW/2);
				}
			}
		}
	}
}

let drag;
function controls()
{
	playerXV = 0;
	playerYV = 0;
	if(wPressed)
	{
		playerYV += playerSpeed*Math.sin(playerRot * Math.PI / 180);
		playerXV += playerSpeed*Math.cos(playerRot * Math.PI / 180);
	}
	if(sPressed)
	{
		playerYV -= playerSpeed*Math.sin(playerRot * Math.PI / 180);
		playerXV -= playerSpeed*Math.cos(playerRot * Math.PI / 180);
	}
	if(aPressed)
	{
		playerYV += playerSpeed*Math.sin((playerRot-90) * Math.PI / 180);
		playerXV += playerSpeed*Math.cos((playerRot-90) * Math.PI / 180);
	}
	if(dPressed)
	{
		playerYV -= playerSpeed*Math.sin((playerRot-90) * Math.PI / 180);
		playerXV -= playerSpeed*Math.cos((playerRot-90) * Math.PI / 180);
	}
	if(mouseIsDown == 1)
	{
		mouseIsDown = 2;
		drag = mouseX;
	}
	if(mouseIsDown == 2)
	{
		var rotation = drag - mouseX;
		playerRot -= rotation;
		drag = mouseX;
	}
	playerX += playerXV;
	playerY += playerYV;
}

function HUD()
{
	//ctx.fillStyle = "red";
//	ctx.font = "20px Ariel";
//	ctx.fillText("N",40,40);
//	ctx.fillStyle = "white";
//	ctx.fillText("S",40,100);
	
//	var cX = 47 + Math.cos(Math.PI * (playerRot) / 180) * 20;
//	var cY = 63 + Math.sin(Math.PI * (playerRot) / 180) * 20;
//	ctx.strokeStyle = "white";
//	ctx.beginPath();
	//ctx.moveTo(47,63);
	//ctx.lineTo(cX,cY);
	//ctx.stroke();
	
	//ctx.fillText(Math.round(playerX)+","+Math.round(playerY),600,100);
}

function render()
{
	ctx.clearRect(0,0,W,H);
	controls();
	drawWalls();
	drawPlayer2D();
	drawWalls2D();
	HUD();
	requestAnimationFrame(render);
}

render();
</script>
</body>
</html>
